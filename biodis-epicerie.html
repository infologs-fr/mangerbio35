<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Convertisseur Biodis -> Socléo pour l'épicerie</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .dropdown-zone {
        margin-bottom: 20px;
      }
      .export-button {
        padding: 10px 20px;
        background-color: #4caf50;
        color: white;
        border: none;
        cursor: pointer;
      }
      .export-button:hover {
        background-color: #45a049;
      }
    </style>
  </head>
  <body>
    <h1>Convertisseur Biodis -> Socléo pour l'épicerie</h1>
    <div class="dropdown-zone">
      <label for="csvFile">Import CSV File:</label>
      <input type="file" id="csvFile" accept=".csv" />
    </div>
    <button class="export-button" onclick="main()">Export</button>

    <script src="utils.js"></script>

    <script>
      const SEPARATOR = ";";

      function main() {
        const fileInput = document.getElementById("csvFile");
        const file = fileInput.files[0];
        if (!file) {
          alert("Please select a CSV file first.");
          return;
        }
        const reader = new FileReader();
        reader.onload = function (event) {
          const arrayBuffer = event.target.result;
          const data = decode_csv(arrayBuffer);
          const lines = clean_check_data(data);
          const output_data = process_lines(lines);
          download_csv(output_data, "biodis_epicerie_converted.csv");
        };
        reader.readAsArrayBuffer(file);
      }

      function clean_check_data(csvData) {
        /*
          Remove useless leading rows and check required headers
        */
        const allRows = csvData.split("\n");
        const startIndex = allRows.findIndex((row) =>
          row.startsWith("Code barre")
        );
        const rows = allRows.slice(startIndex);
        const headers = rows[0].split(SEPARATOR);
        checkRequiredHeaders(headers);
        return rows;
      }

      function checkRequiredHeaders(headers) {
        /*
              Check if all required headers (columns names) are present
              */
        const requiredColumns = [
          "Code art",
          "Famille",
          "Rayon",
          "Gamme",
          "Désignation",
          "UV",
          "TVA",
          "Code barre",
          "Poids",
          "Cond",
          "Origine",
          "Prix Net",
        ];
        const missingColumns = requiredColumns.filter(
          (col) => !headers.includes(col)
        );
        if (missingColumns.length > 0) {
          alert(`Missing columns: ${missingColumns.join(", ")}`);
          throw new Error("Missing required columns");
        }
      }

      function process_lines(lines) {
        const headers = lines[0].split(SEPARATOR);
        // remove headers (first row)
        const rows = lines.slice(1);
        const parsedRows = parseRows(
          rows,
          headers,
          (key = "Code art"),
          (separator = SEPARATOR)
        );
        const outputRows = generateOutputRows(parsedRows);
        return generate_csv(outputRows);
      }

      function generateOutputRows(rows) {
        let outputRows = [];
        rows.forEach((row) => {
          // compute derived fields
          const designation = clean_string(row["Désignation"]);
          const rayon = clean_string(row["Rayon"]);
          const gamme = clean_string(row["Gamme"]);
          const uv = row["UV"].replace("KG", "K").toUpperCase();
          const secteur = row["Famille"] === "FRAIS" ? "BD02" : "BD03";
          const tva = row["TVA"] === "5,5" ? "1" : "2";
          const poids = row["Poids"];
          const conditionnement = row["Cond"];
          const quantite = uv === "U" ? "0,0" : conditionnement;
          const colisage = "1";
          const poidsBrut = uv === "U" ? poids : "0,0";
          const prix = parseFloat(row["Prix Net"].replace(",", "."))
            .toFixed(2)
            .replace(",", "")
            .replace(".", ",");

          // build output row
          const outputRow = build_output_row(
            // Référence
            `"*${row["Code art"]}"`,
            // Code Producteur
            `"NFFU9F44"`,
            // Libellé Producteur
            `"BIODIS"`,
            // Autres producteurs
            `""`,
            // Type produit
            `"local-grocery-store"`,
            // Libellé type produit
            `"Epicerie locale"`,
            // Secteur
            `"${secteur}"`,
            // Famille
            `"${rayon}"`,
            // Sélection
            `"${gamme}"`,
            // Code Agriculture
            `"B"`,
            // Libellé Agriculture
            `"Biologique"`,
            // Forfait qualité
            `""`,
            // Désignation
            `"${designation}"`,
            // Complément
            `""`,
            // Libellé produit
            `""`,
            // Ordre
            `""`,
            // Photo
            `""`,
            // Fiche technique
            `""`,
            // Prix
            `"${prix}"`,
            // Unité de prix
            `"${row["UV"]}"`,
            // Promotion
            `""`,
            // Début de la promotion
            `""`,
            // Fin de la promotion
            `""`,
            // TVA
            `"${tva}"`,
            // Taxe Cotisation interfel
            `""`,
            // Référence EAN 13
            `""`,
            // Référence EAN 14
            `""`,
            // Unité de gestion
            `""`,
            // Conditionnement
            `"${conditionnement}"`,
            // Code produit PLU
            `""`,
            // Quantité
            `"${quantite}"`,
            // Poids Brut
            `"${poidsBrut}"`,
            // Consigne
            `""`,
            // Colisage
            `"${colisage}"`,
            // Produit disponible en ligne
            `""`,
            // Délai de commande (jours)
            `"2"`,
            // Vérifier date d'approvisionnement
            `""`,
            // Quantité disponible
            `""`,
            // Controle seuil approvisionnement
            `"0"`,
            // Date limite
            `""`,
            // Durée de conservation (jours)
            `"0"`,
            // Logos
            `"[EU]"`,
            // Restriction type inclusion
            `""`,
            // Restriction type exclusion
            `""`,
            // Origine production
            `""`,
            // Origine transformation
            `"${row["Origine"]}"`,
            // Note coordinateur
            `""`,
            // Tarif fournisseur
            `"${prix}"`,
            // Règle tarifaire
            `"FLG05"`,
            // Tarif Hub Ethique
            ``,
            // Code catégorie comptable
            `"G"`,
            // Libellé catégorie comptable
            `"Vente de biens"`,
            // Compte de vente
            `"7070171000"`,
            // Compte d'achat
            `"6070171000"`,
            // Conditionnement pour la livraison
            `""`,
            // Colisage pour la livraison
            `"${colisage}"`,
            // Gestion Stock
            `"0"`,
            // Colisage pour l'approvisionnement
            `"0"`,
            // Action en cas de rupture d'approvisionnement
            `"0"`,
            // Gamme Bio accessible
            `""`,
            // Catalogue périphérique
            `""`,
            // Saisonnalité
            `""`,
            // Références externes
            `""`,
            // Zone de stockage
            `""`
          );

          outputRows.push(outputRow.join(SEPARATOR));
        });
        return outputRows;
      }
    </script>
  </body>
</html>
