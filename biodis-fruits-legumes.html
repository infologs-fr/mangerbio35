<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Convertisseur Biodis -> Socléo pour fruits & légumes</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .dropdown-zone {
        margin-bottom: 20px;
      }
      .export-button {
        padding: 10px 20px;
        background-color: #4caf50;
        color: white;
        border: none;
        cursor: pointer;
      }
      .export-button:hover {
        background-color: #45a049;
      }
    </style>
  </head>
  <body>
    <h1>Convertisseur Biodis -> Socléo pour fruits & légumes</h1>
    <div class="dropdown-zone">
      <label for="csvFile">Import CSV File:</label>
      <input type="file" id="csvFile" accept=".csv" />
    </div>
    <button class="export-button" onclick="main()">Export</button>

    <script src="utils.js"></script>

    <script>
      const SEPARATOR = ";";
      // FOOD_DATA is a dict, if the key is found in the product name/designation,
      const FOOD_DATA = {
        plants: { ignore: true },
        ail: { famille: "legumes", sous_famille: "ail", hiver: "oui" },
        artichaut: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        fenouil: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        panais: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        asperge: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        aubergine: {
          famille: "legumes",
          sous_famille: "aubergine",
          hiver: "non",
        },
        bambou: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        batavia: { famille: "legumes", sous_famille: "salade", hiver: "oui" },
        "feuille de chêne": {
          famille: "legumes",
          sous_famille: "salade",
          hiver: "oui",
        },
        betterave: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        blette: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        brède: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        brocoli: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        butternut: { famille: "legumes", sous_famille: "courge", hiver: "oui" },
        carotte: { famille: "legumes", sous_famille: "carotte", hiver: "oui" },
        céleri: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        celeri: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        cebette: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        "céleri-rave": {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        cèpes: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        champignon: {
          famille: "legumes",
          sous_famille: "champignons",
          hiver: "oui",
          substrings: ["de paris", "brun", "shitake"],
        },
        chanterelles: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        chicon: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        chicorée: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        chou: {
          famille: "legumes",
          sous_famille: "chou",
          hiver: "oui",
          substrings: [
            "",
            "blanc",
            "de bruxelles",
            "cabus",
            "chinois",
            "fleur",
            "frisé",
            "kale",
            "navet",
            "palmier",
            "palmiste",
            "rave",
            "romanesco",
            "rouge",
          ],
        },
        citrouille: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        concombre: {
          famille: "legumes",
          sous_famille: "concombre",
          hiver: "non",
        },
        courge: { famille: "legumes", sous_famille: "courge", hiver: "oui" },
        courgette: {
          famille: "legumes",
          sous_famille: "courgette",
          hiver: "non",
        },
        cresson: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        daikon: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        echalote: {
          famille: "legumes",
          sous_famille: "echalote",
          hiver: "oui",
          substrings: ["", "echalotte"],
        },
        edamame: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        endive: { famille: "legumes", sous_famille: "endive", hiver: "oui" },
        epinard: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        frisée: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        "germes de soja": {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        girolle: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        "haricot beurre": {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        "haricot plat": {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        "haricot vert": {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        laitue: { famille: "legumes", sous_famille: "salade", hiver: "oui" },
        mâche: { famille: "legumes", sous_famille: "salade", hiver: "oui" },
        mauve: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        mesclun: { famille: "legumes", sous_famille: "salade", hiver: "oui" },
        maïs: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        morilles: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        navet: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        oignon: { famille: "legumes", sous_famille: "oignon", hiver: "oui" },
        ortie: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        oseille: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        "pak choï": {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        pâtisson: { famille: "legumes", sous_famille: "courge", hiver: "oui" },
        "petits pois": {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        "pe-tsaï": {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        "patate douce": {
          famille: "legumes",
          sous_famille: "patate douce",
          hiver: "oui",
        },
        "pomme de terre": {
          famille: "legumes",
          sous_famille: "pomme de terre",
          hiver: "oui",
        },
        pdt: {
          famille: "legumes",
          sous_famille: "pomme de terre",
          hiver: "oui",
        },
        piment: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        pleurote: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        poireau: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        "pois gourmand": {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        poivron: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "ete",
        },
        potiron: { famille: "legumes", sous_famille: "courge", hiver: "oui" },
        potimarron: {
          famille: "legumes",
          sous_famille: "courge",
          hiver: "oui",
        },
        pourpier: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        radis: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        romaine: { famille: "legumes", sous_famille: "salade", hiver: "oui" },
        roquette: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        rutabaga: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        rhubarbe: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        salsifi: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        scarole: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        tomate: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "ete",
        },
        topinambour: {
          famille: "legumes",
          sous_famille: "autres légumes",
          hiver: "oui",
        },
        salade: { famille: "legumes", sous_famille: "salade", hiver: "oui" },
        ananas: { famille: "fruits", sous_famille: "ananas", hiver: "oui" },
        "citron jaune ": {
          famille: "fruits",
          sous_famille: "agrume",
          hiver: "oui",
        },
        "citron vert ": {
          famille: "fruits",
          sous_famille: "agrume",
          hiver: "oui",
        },
        datte: {
          famille: "fruits",
          sous_famille: "autres fruits",
          hiver: "oui",
        },
        "mandarine ": {
          famille: "fruits",
          sous_famille: "agrume",
          hiver: "oui",
        },
        orange: {
          famille: "fruits",
          sous_famille: "agrume",
          hiver: "oui",
          substrings: [
            "amere",
            "valencia",
            "a jus",
            "washington navel",
            "lanelate",
            "salustiana",
            "sanguine",
            "naveline",
            "feuille saint nicola",
            "azahar",
            "naveline",
            "tarocco rosso",
            "navel",
            "douce vanille",
          ],
        },
        pomelo: { famille: "fruits", sous_famille: "agrume", hiver: "oui" },
        kumquat: {
          famille: "fruits",
          sous_famille: "autres fruits",
          hiver: "oui",
        },
        anone: {
          famille: "fruits",
          sous_famille: "autres fruits",
          hiver: "oui",
        },
        mangue: {
          famille: "fruits",
          sous_famille: "autres fruits",
          hiver: "oui",
        },
        "avocat ": {
          famille: "fruits",
          sous_famille: "autres fruits",
          hiver: "oui",
        },
        kaki: {
          famille: "fruits",
          sous_famille: "autres fruits",
          hiver: "oui",
        },
        kiwi: {
          famille: "fruits",
          sous_famille: "kiwi",
          hiver: "oui",
          substrings: ["hayward", "jaune"],
        },
        banane: {
          famille: "fruits",
          sous_famille: "banane",
          hiver: "oui",
          substrings: ["", "cavendish"],
        },
        curcuma: {
          famille: "fruits",
          sous_famille: "autres fruits",
          hiver: "oui",
        },
        "gingembre ": {
          famille: "fruits",
          sous_famille: "autres fruits",
          hiver: "oui",
        },
        fraise: { famille: "fruits", sous_famille: "fraise", hiver: "ete" },
        cerise: {
          famille: "fruits",
          sous_famille: "autres fruits",
          hiver: "oui",
        },
        "myrtille ": {
          famille: "fruits",
          sous_famille: "autres fruits",
          hiver: "oui",
        },
        "amande ": {
          famille: "fruits",
          sous_famille: "autres fruits",
          hiver: "oui",
        },
        "noisette ": {
          famille: "fruits",
          sous_famille: "autres fruits",
          hiver: "oui",
        },
        "noix ": {
          famille: "fruits",
          sous_famille: "autres fruits",
          hiver: "oui",
        },
        "marrons entiers ": {
          famille: "fruits",
          sous_famille: "autres fruits",
          hiver: "oui",
        },
        "fruits de la passion": {
          famille: "fruits",
          sous_famille: "autres fruits",
          hiver: "oui",
        },
        grenade: {
          famille: "fruits",
          sous_famille: "autres fruits",
          hiver: "oui",
        },
        poire: {
          famille: "fruits",
          sous_famille: "poire",
          hiver: "oui",
          substrings: ["", "comice", "xenia", "conference", "selena"],
        },
        pomme: {
          famille: "fruits",
          sous_famille: "pomme",
          hiver: "oui",
          substrings: [
            "a cuisiner",
            "ariane",
            "belchard",
            "chantecler",
            "crimson crisp",
            "cripps pink",
            "crispp pink",
            "dalinette",
            "gala",
            "golden delicious",
            "goldrush",
            "granny smith",
            "inored",
            "julie",
            "juliet",
            "natyra",
            "patte de loup",
            "pilot",
            "pink lady",
            "pinova",
            "pixie",
            "reinette",
            "story",
            "swing",
            "topaz",
            "xeleven",
          ],
        },
        abricot: { famille: "fruits", sous_famille: "abricot", hiver: "oui" },
        pêche: {
          famille: "fruits",
          sous_famille: "autres fruits",
          hiver: "oui",
        },
        nectarine: {
          famille: "fruits",
          sous_famille: "autres fruits",
          hiver: "oui",
        },
        framboise: {
          famille: "fruits",
          sous_famille: "autres fruits",
          hiver: "oui",
        },
        melon: { famille: "fruits", sous_famille: "melon", hiver: "oui" },
        pastèque: { famille: "fruits", sous_famille: "pastèque", hiver: "oui" },
        prune: { famille: "fruits", sous_famille: "prune", hiver: "oui" },
      };

      function containsWinterProduce(name) {
        // related to FOOD_DATA
        for (const product_name in FOOD_DATA) {
          const product = FOOD_DATA[product_name];
          if (product["hiver"] === "non") {
            if (name.includes(product_name)) {
              return true;
            }
          }
        }
        return false;
      }

      function getProductFamily(name) {
        // related to FOOD_DATA
        for (const product_name in FOOD_DATA) {
          const product = FOOD_DATA[product_name];
          if (name.includes(product_name)) {
            if (product["famille"] === "legumes") {
              return "vegetable";
            }
          }
        }
        return "fruit";
      }

      function getFamily(name) {
        for (const product_name in FOOD_DATA) {
          const product_data = FOOD_DATA[product_name];
          if (name.includes(product_name)) {
            // If substrings field exists, check that at least one is in the name
            if (product_data.substrings) {
              const hasMatch = product_data.substrings.some((substr) =>
                name.includes(substr)
              );
              if (!hasMatch) continue;
            }
            return `${capitalize(product_data["famille"])}-${capitalize(
              product_data["sous_famille"]
            )}`;
          }
        }
        return "Autres";
      }

      function ignoreProduct(name) {
        for (const product_name in FOOD_DATA) {
          const product = FOOD_DATA[product_name];
          if (product["ignore"]) {
            if (name.includes(product_name)) {
              return true;
            }
          }
        }
        return false;
      }

      function main() {
        const fileInput = document.getElementById("csvFile");
        const file = fileInput.files[0];
        if (!file) {
          alert("Please select a CSV file first.");
          return;
        }
        processCSVFile(file);
      }

      function processCSVFile(file) {
        const reader = new FileReader();
        reader.onload = function (event) {
          const arrayBuffer = event.target.result;
          const data = decode_csv(arrayBuffer);
          const lines = clean_check_data(data);
          const output_data = process_lines(lines);
          download_csv(output_data, "biodis_mercuriale_converted.csv");
        };
        reader.readAsArrayBuffer(file);
      }

      function clean_check_data(csvData) {
        /*
          Returns an array of rows (strings) from the CSV data
          Remove useless leading rows and check required headers
        */
        const allRows = csvData.split("\n");
        const startIndex = allRows.findIndex((row) =>
          row.startsWith("Date Mercuriale")
        );
        const rows = allRows.slice(startIndex);
        const headers = rows[0].split(SEPARATOR);
        checkRequiredHeaders(headers);
        return rows;
      }

      function checkRequiredHeaders(headers) {
        /*
          Check if all required headers (columns names) are present
        */
        const requiredColumns = [
          "Designation",
          "Région",
          "Référence",
          "Code BIO",
          "Prix unitaire net",
          "Unité de vente",
          "Colisage",
          "Pays d'origine",
        ];
        const missingColumns = requiredColumns.filter(
          (col) => !headers.includes(col)
        );
        if (missingColumns.length > 0) {
          alert(`Missing columns: ${missingColumns.join(", ")}`);
          throw new Error("Missing required columns");
        }
      }

      function process_lines(lines) {
        const headers = lines[0].split(SEPARATOR);
        console.log(headers);
        // remove headers (first row)
        const rows = lines.slice(1);
        const parsedRows = parseRows(
          rows,
          headers,
          (key = "Référence"),
          (separator = SEPARATOR)
        );
        console.log("12");
        const designationIndex = headers.indexOf("Designation");
        const regionIndex = headers.indexOf("Région");
        const referenceIndex = headers.indexOf("Référence");
        const codeBioIndex = headers.indexOf("Code BIO");
        const filteredRows = filterRows(
          parsedRows,
          designationIndex,
          regionIndex,
          referenceIndex,
          codeBioIndex
        );
        const outputRows = generateOutputRows(filteredRows);
        return generate_csv(outputRows);
      }

      function filterRows(
        rows,
        designationIndex,
        regionIndex,
        referenceIndex,
        codeBioIndex
      ) {
        // Remove rows based on criteria
        const filteredRows = [];
        const uniqueReferences = new Set();
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth();
        const winterMonths = [11, 0, 1, 2]; // December, January, February, March

        rows.forEach((row) => {
          const designation = row["Designation"].toLowerCase();
          const region = row["Région"].toLowerCase();
          const reference = row["Référence"];
          const codeBio = row["Code BIO"];

          if (designation.includes("decoupe")) return;
          if (region.includes("avion")) return;
          if (
            winterMonths.includes(currentMonth) &&
            containsWinterProduce(designation)
          )
            return;
          if (ignoreProduct(designation)) return;
          if (uniqueReferences.has(reference)) return;
          if (codeBio.toLowerCase() === "non bio") return;

          uniqueReferences.add(reference);
          filteredRows.push(row);
        });

        return filteredRows;
      }

      function generateOutputRows(rows) {
        let outputRows = [];
        rows.forEach((row) => {
          const designation = clean_string(row["Designation"].toLowerCase());
          const typeProduit = getProductFamily(designation);
          const famille = getFamily(designation);
          const libelleTypeProduit =
            typeProduit === "fruit" ? "Fruit" : "Légume";
          const unitePrix =
            row["Unité de vente"] === "U"
              ? "U"
              : row["Unité de vente"] === "KG"
              ? "K"
              : "U";
          const prix = (
            parseFloat(row["Prix unitaire net"].replace(",", ".")) * 1.3
          )
            .toFixed(2)
            .replace(",", "")
            .replace(".", ",");
          const forfaitQualite = typeProduit === "fruit" ? "1" : "2";
          const uniteGestion = unitePrix === "U" ? "U" : "COLIS";
          const quantite = unitePrix === "U" ? "0" : parseInt(row["Colisage"]);
          const colisageOutput =
            unitePrix === "U" ? parseInt(row["Colisage"]) : "1";
          const outputRow = build_output_row(
            // Référence
            `"*${row["Référence"]}"`,
            // Code Producteur
            `"NFFU9F44"`,
            // Libellé Producteur
            `"BIODIS"`,
            // Autres producteurs
            `""`,
            // Type produit
            `"${typeProduit}"`,
            // Libellé type produit
            `"${libelleTypeProduit}"`,
            // Secteur
            `"S12"`,
            // Famille
            `"${famille}"`,
            // Sélection
            `""`,
            // Code Agriculture
            `"B"`,
            // Libellé Agriculture
            `"Biologique"`,
            // Forfait qualité
            `"${forfaitQualite}"`,
            // Désignation
            `"${designation}"`,
            // Complément
            `""`,
            // Libellé produit
            `""`,
            // Ordre
            `""`,
            // Photo
            `""`,
            // Fiche technique
            `""`,
            // Prix
            `"${prix}"`,
            // Unité de prix
            `"${unitePrix}"`,
            // Promotion
            `""`,
            // Début de la promotion
            `""`,
            // Fin de la promotion
            `""`,
            // TVA
            `"1"`,
            // Taxe Cotisation interfel
            `"1"`,
            // Motif exemption TVA
            `"1"`,
            // Référence EAN 13
            `""`,
            // Référence EAN 14
            `""`,
            // Unité de gestion
            `"${uniteGestion}"`,
            // Conditionnement
            `""`,
            // Code produit PLU
            `""`,
            // Quantité
            `"${quantite}"`,
            // Poids Brut
            `"0"`,
            // Consigne
            `""`,
            // Colisage
            `"${colisageOutput}"`,
            // Produit disponible en ligne
            `"1"`,
            // Délai de commande (jours)
            `"2"`,
            // Vérifier date d'approvisionnement
            `""`,
            // Quantité disponible
            `""`,
            // Controle seuil approvisionnement
            `"0"`,
            // Date limite
            `""`,
            // Durée de conservation (jours)
            `"0"`,
            // Logos
            `"[EU]"`,
            // Restriction type inclusion
            `""`,
            // Restriction type exclusion
            `""`,
            // Origine production
            `"${row["Pays d'origine"]}"`,
            // Origine transformation
            `""`,
            // Note coordinateur
            `""`,
            // Tarif fournisseur
            `"${row["Prix unitaire net"]}"`,
            // Règle tarifaire
            `"FLG05"`,
            // Tarif Hub Ethique
            ``,
            // Code catégorie comptable
            `"G"`,
            // Libellé catégorie comptable
            `"Vente de biens"`,
            // Compte de vente
            `"7070171000"`,
            // Compte d'achat
            `"6070171000"`,
            // Conditionnement pour la livraison
            `"C001"`,
            // Colisage pour la livraison
            `"0"`,
            // Gestion Stock
            `"0"`,
            // Colisage pour l'approvisionnement
            `"0"`,
            // Action en cas de rupture d'approvisionnement
            `"0"`,
            // Gamme Bio accessible
            `""`,
            // Catalogue périphérique
            `""`,
            // Saisonnalité
            `""`,
            // Références externes
            `""`,
            // Zone de stockage
            `""`
          );

          outputRows.push(outputRow.join(SEPARATOR));
        });
        return outputRows;
      }
    </script>
  </body>
</html>
